{{/* Get Spinoff Codes */}}
{{ $spinoffData := index .Site.Data "spinoffs" }}
{{/* https://github.com/gohugoio/hugo/issues/5959#issuecomment-1951373707 */}}
{{ $keys := slice }}
{{ range $k, $_ := $spinoffData }}
    {{ $keys = $keys | append $k }}
{{ end }}



{{/*  {{ $episodesInSpinoff := slice }}  */}}

<table>

    <tr>
        <th colspan="2">Spinoff</th>
        <th>Air Date</th>
        <th style="text-align: center;">Reviewed / Total Episodes</th>
        <th style="text-align: center;">Best - Average - Minimum Scores</th>
    </tr>

    {{/*  B1. Getting Spinoff List */}}
    {{ range $key := ($keys | collections.Reverse) }}
        {{ $spinoffInfo := index $.Site.Data "spinoffs" $key }}

        {{/*  {{ $episodesInSpinoff := $episodesInSpinoff | append $spinoffInfo.episodeCount }}  */}}

        {{ $pagesInThisSpinoff := where $.Site.RegularPages "Params.spinoffCode" $key }}

        {{ $episodeCount := $pagesInThisSpinoff | len }}
        {{/*  If there is at least 1 review, list contents with title.  */}}
        {{ if gt $episodeCount 0 }}
            {{ $spinoffTotal := $spinoffInfo.episodeCount }}

            {{ $scores := slice }}
            {{ range $pagesInThisSpinoff }}
                {{ with .Params.OverallScore }}
                    {{ $scores = $scores | append . }}
                {{ end }}
            {{ end }}

            {{ $max := float (math.Max $scores) }}
            {{ $min := float (math.Min $scores) }}
            {{ $avg := float (math.Div (math.Sum $scores) $episodeCount) }}
            {{ $maxScore := printf "%.2f" $max }}
            {{ $minScore := printf "%.2f" $min }}
            {{ $averageScore := printf "%.2f" $avg }}

            {{ $spinoff := (index $.Site.Data "spinoffs" $key ) }}

            <tr>
                <td>
                    <a href="/tags/{{$key}}" class="href">
                        <img src="{{$spinoff.logo}}" alt="{{$spinoff.name}} Logo" title="{{$spinoff.name}}" height="22" style="margin: 0px;">
                    </a>
                </td>
                <td>
                    {{ $spinoffInfo.name }}
                </td>
                <td>
                    ({{ $spinoffInfo.year | int }})
                </td>
                <td style="text-align: center;">
                    {{ $episodeCount }} / {{ $spinoffTotal }}
                    <br>
                    <span style="font-size: small;">
                        {{ printf "%.01f" (float (math.Mul (math.Div $episodeCount $spinoffTotal) 100)) }}% Reviewed
                    </span>
                </td>
                <td style="text-align: center;">
                    <div style="
                                height: 20px; 
                                background-color:#F1F8E8; 
                                width: 100%; 
                                display: inline-flex; 
                                border: 1px solid;">
                        
                        <div style="
                                    width: {{$min}}%;
                                    background-color: #D8EFD3; 
                                    "></div>
                        <div style="
                                    width: {{math.Sub $avg $min}}%; 
                                    background-color: #95D2B3"></div>
                        <div style="
                                    width: {{math.Sub $max $avg}}%; 
                                    background-color: #55AD9B;
                                    "></div>
                </div>
                <span style="font-size: small; margin-top: 0px">
                    {{ $minScore }} - {{ $averageScore }} - {{ $maxScore }}
                </span>
            </td>
            </tr>

        {{end}}
    {{end}}


    {{/*  Overall  */}}
    <tr style="font-weight: bold">
        {{ $allEpisodes := where $.Site.RegularPages "Section" "review" }}
        {{ $episodeCount := $allEpisodes | len }}
        {{/*  {{ $grandtotal := math.Sum $episodesInSpinoff }}  */}}
        {{ $grandtotal := 924 }}

        {{ $scores := slice }}
        {{ range $allEpisodes }}
            {{ with .Params.OverallScore }}
                {{ $scores = $scores | append . }}
            {{ end }}
        {{ end }}

        {{ $max := float (math.Max $scores) }}
        {{ $min := float (math.Min $scores) }}
        {{ $avg := float (math.Div (math.Sum $scores) $episodeCount) }}
        {{ $maxScore := printf "%.2f" $max }}
        {{ $minScore := printf "%.2f" $min }}
        {{ $averageScore := printf "%.2f" $avg }}
        
        <td colspan="3">Overall</td>
        <td style="text-align: center;">
            {{ $episodeCount }} / {{ $grandtotal }}
            <br>
            <span style="font-size: small;">
                {{ printf "%.01f" (float (math.Mul (math.Div $episodeCount $grandtotal) 100)) }}% Reviewed
            </span>
        </td>
        <td style="text-align: center;">
            <div style="
                        height: 20px; 
                        background-color:#F1F8E8; 
                        width: 100%; 
                        display: inline-flex; 
                        border: 1px solid;">
                
                <div style="
                            width: {{$min}}%;
                            background-color: #D8EFD3;">
                        </div>
                <div style="
                            width: {{math.Sub $avg $min}}%; 
                            background-color: #95D2B3">
                        </div>
                <div style="
                            width: {{math.Sub $max $avg}}%; 
                            background-color: #55AD9B;">
                        </div>
            </div>
            <span style="font-size: small; margin-top: 0px">
                {{ $minScore }} - {{ $averageScore }} - {{ $maxScore }}
            </span>
        </td>
    </tr>

</table>
